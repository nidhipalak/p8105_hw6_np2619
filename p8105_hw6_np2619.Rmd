---
title: "Homework 6"
author: "Nidhi Patel"
date: "12/9/2020"
output: github_document
---

```{r}
library(tidyverse)
library(modelr)
library(mgcv)
library(p8105.datasets)

knitr::opts_chunk$set(
  fig.width = 6,
  fig.height = 6,
  out.width = "90%")

theme_set(theme_minimal() + theme(legend.position = "bottom"))

options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)

scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d
```

## Problem 1

#### Read in Data + make vars we want

```{r}
homicide = read_csv("./data/homicide-data.csv") %>% 
  unite(city_state, c("city", "state"), sep = "_") %>% 
  filter(city_state != "Tulsa_AL",
         victim_race %in% c("White", "Black"),
         victim_age != "Unknown") %>% 
  mutate(victim_age = as.numeric(victim_age),
         resolution = ifelse(disposition == "Closed by arrest", rep("1"), "0"), 
         resolution = as.factor(resolution))

#1 is traditionally results in successvictim_sex = as.factor(victim_sex),

```

This dataset contains `r ncol(homicide)` variables with `r nrow(homicide)` observations.  Each homicide is distinguished by an unique id, contains basic demographic information about the victim, the location and reported date of the murder, and whether an arrest was made. 

#### Fit GLM for Baltimore

```{r}
bal_fit = homicide %>% 
  filter(city_state != "Baltimore_MD")
  glm(resolution ~ victim_age + victim_sex + victim_race, data = homicide, family = binomial()) %>% 
  broom::tidy() %>% 
  mutate(
    OR = exp(estimate),
    ci_upper = exp(estimate + 1.96 * std.error),
    ci_lower = exp(estimate - 1.96 * std.error)
  ) %>% 
    select(term, OR, starts_with("ci"))
  
  ## NEEDS TO BE ADJUSTED OR for RACE
```

#### Map glm across cities

```{r}
city_mod_results = 
  homicide %>% 
  nest(data = -city_state) %>% 
  mutate(
    models = map(.x = data, ~glm(resolution ~ victim_age + victim_sex + victim_race, data = .x, family = binomial())),
    results = map(models, broom::tidy)
  ) %>% 
  select(city_state, results) %>%
  unnest(results) %>% 
  mutate(
    OR = exp(estimate),
    ci_upper = exp(estimate + 1.96 * std.error),
    ci_lower = exp(estimate - 1.96 * std.error)
  ) %>% 
    filter(term == "victim_raceWhite") %>% 
  select(city_state, OR, starts_with("ci"))
```

#### Create plot

```{r}
OR_plots = city_mod_results %>% 
  mutate(
    city_state = as_factor(city_state),
    city_state = fct_reorder(city_state, OR)
  ) %>% 
  ggplot(aes(x = city_state, y = OR, color = city_state)) +
  geom_point(alpha = 3) +
  geom_errorbar(aes(ymax = ci_upper, ymin = ci_lower)) +
  theme(legend.position = "none", axis.text.x = element_text(angle = 90)) +
  labs(title = "OR and CI of solving homicides comparing non-white victims to white victims"
  ) 

OR_plots
```
We have a plot of odds ratios comparing white homicide victims to black homicide victims. From this plot we see that odds ratios for almost all cities are greater than 1.  This indicates the odds of having an solved case among white victims is much greater than the odds of having a solve case among black victims. However, a little less than half the cities have a confidence interval that overlaps with 1, indicating there is no difference in having a case solved between victims who are black or white. Boston, Omaha and Oakland have very high odds ratios between resolved murders between white and black victim, where white victims are much more likely to be resolved.

